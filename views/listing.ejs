<% layout("/layouts/boilerplate.ejs") -%>
<div class="container">
  <div class="property-header">
    <img src="<%= listing.image.url %>" alt="<%= listing.title %>" />
    <a href="/" class="back-btn">← Back to Listings</a>
  </div>

  <div class="property-content">
    <div>Posted by: <%= listing.owner.username %></div>
    <div class="property-title"><%= listing.title %></div>
    <div class="property-location">
      <%= listing.location %>, <%= listing.country %>
    </div>
    <div class="property-description"><%= listing.description %></div>
    
    <div class="property-info">
      
      <div class="property-price mb-4">$<%= listing.price %> / night</div>
    </div>
  </div>

  <!-- Average Rating Section -->
  <div class="average-rating">
    <% 
      let total = 0;
      for (let review of listing.reviews) { total += review.rating; }
      let avgRating = listing.reviews.length ? (total / listing.reviews.length).toFixed(1) : 0;
    %>
    <span>Average Rating:</span> 
    <span class="stars">
      <% for(let i = 0; i < Math.floor(avgRating); i++){ %>★<% } %>
      <% if(avgRating % 1 >= 0.5){ %>½<% } %>
    </span>
    (<%= avgRating %> / 5)
  </div>

  <div class="review-section">
    <h3>Reviews</h3>

    <!-- Review List -->
    <div class="review-list">
  <% if(listing.reviews.length === 0){ %>
    <p>No reviews yet.</p>
  <% } else { %>
    <% for(let review of listing.reviews){ %>
      <div class="review-card">
        <div class="review-rating">
          <% for(let i=0; i<review.rating; i++){ %>★<% } %>
        </div>
        <div class="review-comment"><%= review.comment %></div>
        <div class="review-comment" style="text-align: right;">
          By: <%= review.reviewer.username %>
        </div>
          <!-- Delete button using method-override -->
           <% if(user && user._id.toString() === review.reviewer._id.toString()){ %>
          <form action="/review/listing/<%= review._id %>/<%= listing._id %>?_method=DELETE" method="POST" class="delete-form">
            <button type="submit" class="delete-btn">Delete</button>
          </form>
          <% } %>
      </div>
    <% } %>
  <% } %>
</div>


    <!-- Add Review Button -->
    <a href="/review/listing/<%= listing._id %>" class="add-btn">+ Add Review</a>
  </div>
</div>
